<!DOCTYPE html>
<html>
<head>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;500;600&display=swap');

    :root {
      --bg: rgba(15, 15, 25, 0.85);
      --accent: #00d4aa;
      --accent2: #7c3aed;
      --text: #f0f0f5;
      --text-dim: #a0a0b0;
      --border: rgba(255, 255, 255, 0.08);
      --danger: #ff4757;
    }

    * { box-sizing: border-box; user-select: none; }

    html, body {
      margin: 0; padding: 0; height: 100%;
      overflow: hidden; background: transparent;
      font-family: 'Outfit', sans-serif;
    }

    #app {
      width: 100%; height: 100%;
      display: flex; flex-direction: column;
      background: transparent;
      border-radius: 12px;
      border: none;
      overflow: hidden;
    }

    #app.active {
      background: var(--bg);
      border: 2px solid rgba(0, 212, 170, 0.6);
    }

    /* Drag bar */
    #drag-bar {
      display: none;
      padding: 10px 14px;
      background: linear-gradient(180deg, rgba(0, 212, 170, 0.2), rgba(0, 212, 170, 0.05));
      border-bottom: 1px solid rgba(0, 212, 170, 0.6);
      font: 11px 'JetBrains Mono', monospace;
      color: var(--accent);
      cursor: grab;
      align-items: center;
      justify-content: space-between;
    }
    #drag-bar:active { cursor: grabbing; }
    #app.active #drag-bar { display: flex; }

    .grip { display: flex; gap: 3px; }
    .grip span { width: 5px; height: 5px; background: var(--accent); border-radius: 50%; }

    .bar-btn {
      border: none; color: white;
      padding: 6px 12px; border-radius: 6px; cursor: pointer;
      font: 500 12px 'Outfit', sans-serif;
    }
    #closeBtn { background: var(--danger); }
    #closeBtn:hover { background: #ff6b7a; }
    #settingsBtn, #passiveBtn { background: rgba(255,255,255,0.15); }
    #settingsBtn:hover, #passiveBtn:hover { background: rgba(255,255,255,0.25); }

    /* Messages */
    #messages {
      flex: 1; overflow-y: auto; padding: 8px 8px 4px 8px;
      display: flex; flex-direction: column;
      justify-content: flex-end; gap: 4px;
      align-items: flex-start;
    }
    #messages::-webkit-scrollbar { width: 5px; }
    #messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

    .msg {
      background: rgba(15, 15, 25, 0.9);
      backdrop-filter: blur(10px);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 13px; line-height: 1.3;
      border: 1px solid var(--border);
      animation: slideUp 0.3s ease;
      position: relative;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.35);
      width: fit-content;
      max-width: 90%;
      transition: opacity 0.3s ease;
    }
    .msg::before {
      content: ''; position: absolute;
      top: 0; left: 0; width: 3px; height: 100%;
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      border-radius: 3px 0 0 3px;
    }

    .msg .del {
      display: none; position: absolute;
      top: 4px; right: 4px;
      width: 18px; height: 18px;
      background: var(--danger); border: none;
      border-radius: 4px; cursor: pointer;
      color: white; font-size: 10px;
      line-height: 18px; text-align: center;
    }
    #app.active .msg:hover .del { display: block; }

    .msg .user {
      color: var(--accent); font-weight: 600;
      font: 600 11px 'JetBrains Mono', monospace;
      display: inline;
      margin-right: 6px;
    }
    
    .msg .text { display: inline; }

    .msg img {
      max-width: 120px; display: block;
      margin-top: 8px; border-radius: 6px;
      border: 1px solid var(--border);
    }

    /* Resize edges - invisible but functional */
    .resize-edge {
      display: none; position: absolute;
      background: transparent;
      z-index: 100;
    }
    #app.active .resize-edge { display: block; }
    
    .resize-edge.top { top: 0; left: 10px; right: 10px; height: 8px; cursor: n-resize; }
    .resize-edge.bottom { bottom: 0; left: 10px; right: 10px; height: 8px; cursor: s-resize; }
    .resize-edge.left { left: 0; top: 10px; bottom: 10px; width: 8px; cursor: w-resize; }
    .resize-edge.right { right: 0; top: 10px; bottom: 10px; width: 8px; cursor: e-resize; }
    
    .resize-edge.top-left { top: 0; left: 0; width: 14px; height: 14px; cursor: nw-resize; }
    .resize-edge.top-right { top: 0; right: 0; width: 14px; height: 14px; cursor: ne-resize; }
    .resize-edge.bottom-left { bottom: 0; left: 0; width: 14px; height: 14px; cursor: sw-resize; }
    .resize-edge.bottom-right { bottom: 0; right: 0; width: 14px; height: 14px; cursor: se-resize; }


    /* Join text */
    #join-text {
      padding: 0 8px 8px 8px;
      font: 500 11px 'JetBrains Mono', monospace;
      color: var(--text-dim);
      display: none;
    }
    #join-text.visible { display: block; }
    #join-text span { color: var(--accent); }

    /* Mode indicator */
    #mode {
      position: absolute; bottom: 10px; left: 10px;
      background: rgba(15, 15, 25, 0.9);
      backdrop-filter: blur(10px);
      padding: 5px 10px; border-radius: 6px;
      font: 10px 'JetBrains Mono', monospace;
      color: var(--text-dim);
      opacity: 0; transition: opacity 0.3s;
      pointer-events: none;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    #mode.show { opacity: 1; }

    /* Settings panel */
    #settings {
      display: none;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(15, 15, 25, 0.98);
      backdrop-filter: blur(16px);
      padding: 20px 24px;
      border-radius: 14px;
      border: 1px solid rgba(0, 212, 170, 0.3);
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
      z-index: 200;
      min-width: 220px;
    }
    #settings.open { display: block; }

    #settings h3 {
      margin: 0 0 16px 0;
      font: 600 14px 'JetBrains Mono', monospace;
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    #settings .close-settings {
      background: none; border: none;
      color: var(--text-dim); cursor: pointer;
      font-size: 16px; padding: 0;
    }
    #settings .close-settings:hover { color: var(--text); }

    #settings label {
      font: 11px 'JetBrains Mono', monospace;
      color: var(--text-dim);
      display: block;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #settings .setting-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #settings input[type="range"] {
      flex: 1;
      accent-color: var(--accent);
      height: 6px;
    }

    #settings .value {
      font: 600 16px 'JetBrains Mono', monospace;
      color: var(--accent);
      min-width: 28px;
      text-align: center;
    }

    /* Settings backdrop */
    #settings-backdrop, #confirm-backdrop {
      display: none;
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 150;
    }
    #settings-backdrop.open, #confirm-backdrop.open { display: block; }

    /* Confirm dialog */
    #confirm-dialog {
      display: none;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(15, 15, 25, 0.98);
      backdrop-filter: blur(16px);
      padding: 20px 24px;
      border-radius: 14px;
      border: 1px solid rgba(255, 71, 87, 0.4);
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
      z-index: 200;
      text-align: center;
      min-width: 260px;
    }
    #confirm-dialog.open { display: block; }

    #confirm-dialog p {
      margin: 0 0 20px 0;
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
    }

    #confirm-dialog .btn-row {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    #confirm-dialog button {
      padding: 8px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font: 500 13px 'Outfit', sans-serif;
    }

    #confirm-dialog .cancel-btn {
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }
    #confirm-dialog .cancel-btn:hover { background: rgba(255,255,255,0.2); }

    #confirm-dialog .confirm-btn {
      background: var(--danger);
      color: white;
    }
    #confirm-dialog .confirm-btn:hover { background: #ff6b7a; }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="drag-bar">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="grip"><span></span><span></span><span></span></div>
        DRAG TO MOVE
      </div>
      <div style="display:flex;gap:8px">
        <button id="passiveBtn" class="bar-btn" title="Immersive Mode Ctrl+Shift+O/F9">üëÅ</button>
        <button id="settingsBtn" class="bar-btn" title="Settings">‚öô</button>
        <button id="closeBtn" class="bar-btn" title="End Session">‚úï</button>
      </div>
    </div>

    <div id="messages"></div>
    <div id="join-text">Join LiveChat: <span id="session-code">ABC123</span></div>
    
    <!-- Resize edges -->
    <div class="resize-edge top" data-dir="n"></div>
    <div class="resize-edge bottom" data-dir="s"></div>
    <div class="resize-edge left" data-dir="w"></div>
    <div class="resize-edge right" data-dir="e"></div>
    <div class="resize-edge top-left" data-dir="nw"></div>
    <div class="resize-edge top-right" data-dir="ne"></div>
    <div class="resize-edge bottom-left" data-dir="sw"></div>
    <div class="resize-edge bottom-right" data-dir="se"></div>
    
    <div id="settings-backdrop"></div>
    <div id="settings">
      <h3>
        Settings
        <button class="close-settings">‚úï</button>
      </h3>
      <label>Max Messages</label>
      <div class="setting-row">
        <input type="range" id="maxMsgSlider" min="2" max="10" value="5">
        <span class="value" id="maxMsgValue">5</span>
      </div>
      
      <label style="margin-top:16px">Font Size</label>
      <div class="setting-row">
        <input type="range" id="fontSizeSlider" min="10" max="20" value="13">
        <span class="value" id="fontSizeValue">13</span>
      </div>
      
      <label style="margin-top:16px">
        <input type="checkbox" id="showJoinCode" checked style="margin-right:8px;accent-color:var(--accent)">
        Show Join Code
      </label>
    </div>

    <div id="confirm-backdrop"></div>
    <div id="confirm-dialog">
      <p>Are you sure you want to<br>end the session?</p>
      <div class="btn-row">
        <button class="cancel-btn">Cancel</button>
        <button class="confirm-btn">End Session</button>
      </div>
    </div>
    
    <div id="mode">PASSIVE</div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    const $ = id => document.getElementById(id);
    const app = $('app'), dragBar = $('drag-bar');
    const messages = $('messages'), mode = $('mode');

    let dragging = false, resizing = false, resizeDir = '';
    let lastX = 0, lastY = 0;
    let startX = 0, startY = 0, startW = 0, startH = 0, startPosX = 0, startPosY = 0;

    // Drag
    dragBar.onmousedown = e => {
      if (e.target.id === 'closeBtn') return;
      dragging = true;
      lastX = e.screenX; lastY = e.screenY;
    };

    // Resize from any edge
    document.querySelectorAll('.resize-edge').forEach(edge => {
      edge.onmousedown = async e => {
        resizing = true;
        resizeDir = edge.dataset.dir;
        const b = await ipcRenderer.invoke('get-window-bounds');
        startX = e.screenX; startY = e.screenY;
        startW = b.width; startH = b.height;
        startPosX = b.x; startPosY = b.y;
        e.preventDefault();
      };
    });

    document.onmousemove = e => {
      if (dragging) {
        ipcRenderer.send('window-move', { deltaX: e.screenX - lastX, deltaY: e.screenY - lastY });
        lastX = e.screenX; lastY = e.screenY;
      }
      if (resizing) {
        const dx = e.screenX - startX;
        const dy = e.screenY - startY;
        let x, y, w = startW, h = startH;

        // Handle each direction
        if (resizeDir.includes('e')) w = startW + dx;
        if (resizeDir.includes('w')) { w = startW - dx; x = startPosX + dx; }
        if (resizeDir.includes('s')) h = startH + dy;
        if (resizeDir.includes('n')) { h = startH - dy; y = startPosY + dy; }

        ipcRenderer.send('window-resize', { width: w, height: h, x, y });
      }
    };

    document.onmouseup = () => { dragging = false; resizing = false; resizeDir = ''; };

    // Mode toggle
    ipcRenderer.on('mode-change', (_, m) => {
      mode.textContent = m.toUpperCase();
      mode.classList.add('show');
      app.classList.toggle('active', m === 'active');
      if (m === 'passive') {
        closeSettings();
        setTimeout(() => mode.classList.remove('show'), 2000);
      }
    });

    // Enter passive mode
    $('passiveBtn').onclick = () => ipcRenderer.send('enter-passive');

    // Close app with confirmation
    const confirmDialog = $('confirm-dialog');
    const confirmBackdrop = $('confirm-backdrop');

    function showConfirm() {
      confirmDialog.classList.add('open');
      confirmBackdrop.classList.add('open');
    }

    function hideConfirm() {
      confirmDialog.classList.remove('open');
      confirmBackdrop.classList.remove('open');
    }

    $('closeBtn').onclick = showConfirm;
    confirmBackdrop.onclick = hideConfirm;
    confirmDialog.querySelector('.cancel-btn').onclick = hideConfirm;
    confirmDialog.querySelector('.confirm-btn').onclick = () => ipcRenderer.send('close-app');

    // Settings menu
    const settings = $('settings');
    const settingsBackdrop = $('settings-backdrop');
    
    function openSettings() {
      settings.classList.add('open');
      settingsBackdrop.classList.add('open');
    }
    
    function closeSettings() {
      settings.classList.remove('open');
      settingsBackdrop.classList.remove('open');
    }

    $('settingsBtn').onclick = openSettings;
    settings.querySelector('.close-settings').onclick = closeSettings;
    settingsBackdrop.onclick = closeSettings;

    // Settings
    let maxMessages = 5;
    const maxMsgSlider = $('maxMsgSlider');
    const maxMsgValue = $('maxMsgValue');

    maxMsgSlider.oninput = () => {
      maxMessages = parseInt(maxMsgSlider.value);
      maxMsgValue.textContent = maxMessages;
      trimMessages();
      updateOpacity();
    };

    // Font size setting
    const fontSizeSlider = $('fontSizeSlider');
    const fontSizeValue = $('fontSizeValue');

    function applyFontSize(size) {
      document.querySelectorAll('.msg').forEach(msg => {
        msg.style.fontSize = size + 'px';
        msg.querySelector('.user').style.fontSize = (size - 2) + 'px';
      });
      messages.dataset.fontSize = size;
    }

    fontSizeSlider.oninput = () => {
      const size = parseInt(fontSizeSlider.value);
      fontSizeValue.textContent = size;
      applyFontSize(size);
    };

    // Join code visibility
    const joinText = $('join-text');
    const showJoinCodeCheckbox = $('showJoinCode');
    let showJoinCode = true;

    function updateJoinTextVisibility() {
      const hasMessages = messages.children.length > 0;
      if (showJoinCode && hasMessages) {
        joinText.classList.add('visible');
      } else {
        joinText.classList.remove('visible');
      }
    }

    showJoinCodeCheckbox.onchange = () => {
      showJoinCode = showJoinCodeCheckbox.checked;
      updateJoinTextVisibility();
    };

    // Trim excess messages
    function trimMessages() {
      while (messages.children.length > maxMessages) {
        messages.firstChild.remove();
      }
    }

    // Update opacity with gentle decay (stays visible longer, gradual fade)
    function updateOpacity() {
      const msgs = messages.querySelectorAll('.msg');
      const count = msgs.length;
      msgs.forEach((msg, i) => {
        const age = count - 1 - i; // 0 = newest, higher = older
        const normalizedAge = age / Math.max(1, maxMessages - 1); // 0 to 1
        // Gentle ease-out curve using cosine for smooth natural fade
        const opacity = Math.cos(Math.pow(normalizedAge, 1.3) * Math.PI / 2);
        msg.style.opacity = Math.max(0.1, opacity);
      });
    }

    // Auto-hide timeout (in ms)
    const MSG_DISPLAY_TIME = 5000;

    // Generate consistent color for username
    function getUserColor(username) {
      // Hash the username to get a consistent number
      let hash = 0;
      for (let i = 0; i < username.length; i++) {
        hash = username.charCodeAt(i) + ((hash << 5) - hash);
        hash = hash & hash; // Convert to 32bit integer
      }
      
      // Use hash to generate HSL color
      const hue = Math.abs(hash) % 360;
      const saturation = 65 + (Math.abs(hash >> 8) % 20); // 65-85%
      const lightness = 65 + (Math.abs(hash >> 16) % 15);  // 65-80%
      
      return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }

    // Message helpers
    function addMsg(user, text) {
      const el = document.createElement('div');
      el.className = 'msg';
      el.innerHTML = `<button class="del">üóë</button><span class="user">${user}:</span><span class="text">${text}</span>`;
      
      // Apply username color
      const userEl = el.querySelector('.user');
      userEl.style.color = getUserColor(user);
      
      // Apply custom font size if set
      if (messages.dataset.fontSize) {
        const size = parseInt(messages.dataset.fontSize);
        el.style.fontSize = size + 'px';
        userEl.style.fontSize = (size - 2) + 'px';
      }
      
      // Delete button handler
      el.querySelector('.del').onclick = () => {
        el.style.transition = 'opacity 1.3s';
        el.style.opacity = '0';
        setTimeout(() => { el.remove(); updateOpacity(); updateJoinTextVisibility(); }, 1300);
      };
      
      // Auto-hide after display time
      setTimeout(() => {
        if (el.parentNode) {
          el.style.transition = 'opacity 1.3s';
          el.style.opacity = '0';
          setTimeout(() => { el.remove(); updateOpacity(); updateJoinTextVisibility(); }, 1300);
        }
      }, MSG_DISPLAY_TIME);
      
      messages.appendChild(el);
      trimMessages();
      messages.scrollTop = messages.scrollHeight;
      updateOpacity();
      updateJoinTextVisibility();
    }

    // Initial messages
    addMsg('MovieFan42', 'Whoa, did you see that scene?! üî•');
    addMsg('CinemaLover', 'This cinematography is incredible');

    // Mock feed
    const users = ['FilmBuff99', 'CinemaFan', 'MovieNerd', 'ScreenTime', 'PopcornKing'];
    const texts = ['This scene is legendary! üé¨', 'Wait for it...', 'Best part coming up!', 'That plot twist though üòÆ', 'The soundtrack here üéµ'];
    setInterval(() => addMsg(users[Math.random()*users.length|0], texts[Math.random()*texts.length|0]), 4000);

    // Show mode on start
    setTimeout(() => { mode.classList.add('show'); setTimeout(() => mode.classList.remove('show'), 2000); }, 500);
  </script>
</body>
</html>
